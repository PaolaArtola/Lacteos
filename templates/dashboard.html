{% extends 'base.html' %}
{% load tz %}

{% block title %}Dashboard - Lactería El Buen Sabor{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        margin-bottom: 2rem;
    }

    .dashboard-header h1 {
        color: #2c5f2d;
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #2c5f2d;
    }

    .stat-card h3 {
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card .value {
        font-size: 2rem;
        font-weight: 700;
        color: #2c5f2d;
        margin-bottom: 0.25rem;
    }

    .stat-card .sub-value {
        color: #888;
        font-size: 0.85rem;
    }

    .stat-card.primary {
        border-left-color: #2c5f2d;
    }

    .stat-card.success {
        border-left-color: #28a745;
    }

    .stat-card.info {
        border-left-color: #17a2b8;
    }

    .stat-card.warning {
        border-left-color: #ffc107;
    }

    .dashboard-section {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .dashboard-section h2 {
        color: #2c5f2d;
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .table th,
    .table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #555;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .table tbody tr:last-child td {
        border-bottom: none;
    }

    .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .badge-success {
        background-color: #d4edda;
        color: #155724;
    }

    .badge-warning {
        background-color: #fff3cd;
        color: #856404;
    }

    .badge-danger {
        background-color: #f8d7da;
        color: #721c24;
    }

    .badge-info {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .chart-container {
        margin-top: 1rem;
    }

    .chart-bar {
        display: flex;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .chart-bar-label {
        width: 100px;
        font-size: 0.85rem;
        color: #666;
    }

    .chart-bar-visual {
        flex: 1;
        height: 24px;
        background-color: #e9ecef;
        border-radius: 4px;
        position: relative;
        overflow: hidden;
    }

    .chart-bar-fill {
        height: 100%;
        background-color: #2c5f2d;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .chart-bar-value {
        width: 100px;
        text-align: right;
        font-size: 0.85rem;
        font-weight: 600;
        color: #2c5f2d;
    }

    .two-column {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }

    @media (max-width: 768px) {
        .two-column {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }
    }

    .text-right {
        text-align: right;
    }

    .text-success {
        color: #28a745;
    }

    .text-danger {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h1>Panel de Control</h1>
    <p>Resumen de ventas, ingresos y métricas clave</p>
</div>

<!-- Key Metrics -->
<div class="stats-grid">
    <div class="stat-card primary">
        <h3>Ingresos Totales</h3>
        <div class="value">${{ total_revenue|floatformat:2 }}</div>
        <div class="sub-value">De todos los tiempos</div>
    </div>

    <div class="stat-card success">
        <h3>Ganancia Total</h3>
        <div class="value">${{ total_profit|floatformat:2 }}</div>
        <div class="sub-value">ROI: {{ overall_roi|floatformat:2 }}%</div>
    </div>

    <div class="stat-card info">
        <h3>Ventas Totales</h3>
        <div class="value">{{ total_sales }}</div>
        <div class="sub-value">Transacciones</div>
    </div>

    <div class="stat-card warning">
        <h3>Venta Promedio</h3>
        <div class="value">${{ avg_sale_amount|floatformat:2 }}</div>
        <div class="sub-value">Por transacción</div>
    </div>
</div>

<!-- Today's Performance -->
<div class="stats-grid">
    <div class="stat-card primary">
        <h3>Ingresos de Hoy</h3>
        <div class="value">${{ today_revenue|floatformat:2 }}</div>
        <div class="sub-value">{{ today_count }} venta{{ today_count|pluralize }}</div>
    </div>

    <div class="stat-card success">
        <h3>Ganancia de Hoy</h3>
        <div class="value">${{ today_profit|floatformat:2 }}</div>
        <div class="sub-value">De las ventas de hoy</div>
    </div>

    <div class="stat-card info">
        <h3>Últimos 7 Días</h3>
        <div class="value">${{ recent_revenue|floatformat:2 }}</div>
        <div class="sub-value">{{ recent_sales_count }} venta{{ recent_sales_count|pluralize }}</div>
    </div>

    <div class="stat-card warning">
        <h3>Últimos 30 Días</h3>
        <div class="value">${{ monthly_revenue|floatformat:2 }}</div>
        <div class="sub-value">{{ monthly_sales_count }} venta{{ monthly_sales_count|pluralize }}</div>
    </div>
</div>

<!-- Sales by Day Chart -->
<div class="dashboard-section">
    <h2>Tendencia de Ventas (Últimos 7 Días)</h2>
    <div class="chart-container">
        {% for day in sales_by_day %}
        <div class="chart-bar">

            {% timezone "America/Lima" %}
                <div class="chart-bar-label">{{ day.date|date:"D, M d" }}</div>
            {% endtimezone %}
            <div class="chart-bar-visual">
                {% if max_revenue > 0 %}
                    {% widthratio day.revenue max_revenue 100 as width %}
                    <div class="chart-bar-fill" style="width: {% if width > 0 %}{{ width }}{% else %}1{% endif %}%"></div>
                {% else %}
                    <div class="chart-bar-fill" style="width: 0%"></div>
                {% endif %}
            </div>
            <div class="chart-bar-value">${{ day.revenue|floatformat:2 }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Latest Sales -->
<div class="dashboard-section">
    <h2>Últimas Ventas</h2>
    {% if latest_sales %}
    <table class="table">
        <thead>
            <tr>
                <th>ID Venta</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Monto</th>
                <th>Ganancia</th>
                <th>ROI</th>
                <th>Items</th>
            </tr>
        </thead>
        <tbody>
            {% for sale in latest_sales %}
            <tr>
                <td>#{{ sale.id }}</td>
                {% timezone "America/Lima" %}
                    <td>{{ sale.sale_date|date:"d M Y H:i" }}</td>
                {% endtimezone %}
                <td>{{ sale.customer_name|default:"Cliente sin nombre" }}</td>
                <td class="text-right">${{ sale.total_amount|floatformat:2 }}</td>
                <td class="text-right text-success">${{ sale.total_profit|floatformat:2 }}</td>
                <td class="text-right">
                    <span class="badge {% if sale.roi > 0 %}badge-success{% else %}badge-danger{% endif %}">
                        {{ sale.roi|floatformat:2 }}%
                    </span>
                </td>
                <td>{{ sale.saleitem_set.count }} producto{{ sale.saleitem_set.count|pluralize }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No se han registrado ventas aún.</p>
    {% endif %}
</div>

<!-- Two Column Layout -->
<div class="two-column">
    <!-- Top Products -->
    <div class="dashboard-section">
        <h2>Productos Más Vendidos</h2>
        {% if top_products %}
        <table class="table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Ingresos</th>
                    <th>Ganancia</th>
                </tr>
            </thead>
            <tbody>
                {% for product in top_products %}
                <tr>
                    <td>{{ product.lacteo__name }}</td>
                    <td>{{ product.total_quantity }}</td>
                    <td class="text-right">${{ product.total_revenue|floatformat:2 }}</td>
                    <td class="text-right text-success">${{ product.total_profit|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No hay datos de ventas de productos disponibles.</p>
        {% endif %}
    </div>

    <!-- Low Stock Alert -->
    <div class="dashboard-section">
        <h2>Alerta de Stock Bajo</h2>
        {% if low_stock_products %}
        <table class="table">
            <thead>
                <tr>
                    <th>Producto</th>
                    <th>Stock</th>
                    <th>Unidad</th>
                    <th>Estado</th>
                </tr>
            </thead>
            <tbody>
                {% for product in low_stock_products %}
                <tr>
                    <td>{{ product.name }}</td>
                    <td>{{ product.stock }}</td>
                    <td>{{ product.unit }}</td>
                    <td>
                        {% if product.stock < 5 %}
                            <span class="badge badge-danger">Crítico</span>
                        {% else %}
                            <span class="badge badge-warning">Bajo</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Todos los productos tienen stock suficiente.</p>
        {% endif %}
    </div>
</div>

<!-- Performance Metrics -->
<div class="dashboard-section">
    <h2>Métricas de Rendimiento</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Ganancia Promedio por Venta</h3>
            <div class="value">${{ avg_profit_per_sale|floatformat:2 }}</div>
        </div>
        <div class="stat-card">
            <h3>ROI Promedio</h3>
            <div class="value">{{ avg_roi|floatformat:2 }}%</div>
        </div>
        <div class="stat-card">
            <h3>Ganancia Mensual</h3>
            <div class="value">${{ monthly_profit|floatformat:2 }}</div>
            <div class="sub-value">Últimos 30 días</div>
        </div>
        <div class="stat-card">
            <h3>Ganancia Semanal</h3>
            <div class="value">${{ recent_profit|floatformat:2 }}</div>
            <div class="sub-value">Últimos 7 días</div>
        </div>
    </div>
</div>
{% endblock %}

